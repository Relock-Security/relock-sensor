resolver ${RESOLVER_IPS} ipv6=off valid=30s;
resolver_timeout 5s;

map $host $relock_upstream_host {
    default "";

    ${HOST} ${UPSTREAM};
    ~^(?<sub>[^.]+)\.${HOST}$ ${sub}.${UPSTREAM};
}

# /etc/nginx/conf.d/default.conf (example)
# HTTP -> HTTPS redirect
server {

    listen 80;
    listen [::]:80;

    server_name ${HOST} *.${HOST};

    return 301 https://$host$request_uri;
}

# HTTPS reverse proxy
server {

    listen 443 ssl http2 fastopen=256;
    listen [::]:443 ssl http2 fastopen=256;

    server_name ${HOST} *.${HOST};

    root /demo;

    ssl_certificate     /demo/${CRT};
    ssl_certificate_key /demo/${KEY};

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_session_timeout 1d;
    ssl_session_cache shared:SSL:10m;
    ssl_session_tickets off;

    # If you have real CA-issued certs you can consider OCSP stapling.
    # With self-signed demo certs it usually wonâ€™t help.
    # resolver 1.1.1.1 8.8.8.8 valid=300s;
    # resolver_timeout 5s;
    # ssl_stapling on;
    # ssl_stapling_verify on;

    # Security headers (apply to all responses)
    add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;
    add_header X-Content-Type-Options nosniff always;
    add_header X-Frame-Options SAMEORIGIN always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    #add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
    #add_header Content-Security-Policy "default-src 'self'; object-src 'none'; base-uri 'self'; frame-ancestors 'self'" always;

    # Reasonable proxy timeouts
    proxy_connect_timeout 3s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
    send_timeout 60s;

    # Optional: better client body limit for uploads
    # client_max_body_size 128m;

    location = /nginx/authn {
        internal;
        proxy_pass              https://$relock_upstream_host;

        proxy_pass_request_body off;

        proxy_set_header        Content-Length "";
        proxy_set_header Host $relock_upstream_host;

        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-AuthN-URI $request_uri;
        proxy_set_header X-AuthN-Method $request_method;
        proxy_set_header Origin $http_origin;

        proxy_redirect off;
    }

    # --- /relock prefix handling ---
    # Redirect /relock (no trailing slash) to /relock/
    location = /relock {
        return 301 /relock/;
    }

    # Proxy ONLY paths that start with /relock/
    # IMPORTANT: trailing slash on proxy_pass strips the /relock/ prefix:
    #   /relock/login  ->  https://relock.cloud/login
    location ^~ /relock/ {

        if ($relock_upstream_host = "") { return 444; }
        
        proxy_ssl_server_name on;
        proxy_ssl_name $relock_upstream_host;

        proxy_pass https://$relock_upstream_host;

        # If upstream expects Host relock.demo keep this; otherwise use relock.cloud or $host.
        proxy_set_header Host $relock_upstream_host;

        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header Origin $http_origin;

        proxy_redirect off;
    }

    # Fast path for real static URLs
    location ~* \.(svg|png)$ {
        proxy_pass http://127.0.0.1:8080;

        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header Vary "Accept-Encoding";
        access_log off;
    }

    # --- Default app (WSGI) ---
    location / {

        auth_request     /nginx/authn;
        auth_request_set $auth_status $upstream_status;

        proxy_pass http://127.0.0.1:8080;

        proxy_redirect off;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;

        # For most apps, buffering ON is better. Only disable if you stream (SSE/websocket, etc.)
        # proxy_buffering off;
        proxy_max_temp_file_size 0;
    }
}
